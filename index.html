<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduCore Pro â€” Podar School ERP</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--navy:#0d1b36;--navy3:#1e3460;--gold:#e8b84b;--cream:#f8f5ef;--text:#1a2a3a;--muted:#6b7f96;--border:#e2e8f0;--green:#16a34a;--green-bg:#dcfce7;--red:#dc2626;--red-bg:#fee2e2;--orange:#d97706;--orange-bg:#fef3c7;--blue:#2563eb;--blue-bg:#dbeafe;--purple:#7c3aed;--purple-bg:#ede9fe;--sidebar:250px;--radius:12px;--shadow:0 4px 20px rgba(0,0,0,0.07);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text);display:flex;min-height:100vh;}
#loading{position:fixed;inset:0;background:var(--navy);display:flex;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:16px;}
.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.2);border-top:4px solid var(--gold);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
#loading p{color:white;font-size:14px;opacity:.7;}
#loginPage{position:fixed;inset:0;background:linear-gradient(135deg,var(--navy),var(--navy3));display:flex;align-items:center;justify-content:center;z-index:1000;display:none;}
.login-box{background:white;border-radius:20px;padding:48px 40px;width:420px;box-shadow:0 30px 80px rgba(0,0,0,0.3);animation:popIn .5s cubic-bezier(.34,1.56,.64,1);}
@keyframes popIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo h1{font-family:'Playfair Display',serif;font-size:28px;color:var(--navy);}
.login-logo p{color:var(--muted);font-size:13px;margin-top:4px;}
.badge{display:inline-block;background:var(--gold);color:var(--navy);font-size:10px;font-weight:700;padding:2px 10px;border-radius:20px;letter-spacing:1px;text-transform:uppercase;margin-top:8px;}
.fg{margin-bottom:16px;}
.fg label{display:block;font-size:13px;font-weight:600;color:var(--navy);margin-bottom:6px;}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);transition:border-color .2s;outline:none;background:white;}
.fg input:focus,.fg select:focus{border-color:var(--navy);}
.login-btn{width:100%;padding:13px;background:var(--navy);color:white;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:8px;}
.login-btn:hover{background:var(--navy3);}
.login-btn:disabled{opacity:.6;cursor:not-allowed;}
.error-msg{background:var(--red-bg);color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none;}
.success-msg{background:var(--green-bg);color:var(--green);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none;}
.sec-note{display:flex;align-items:center;gap:8px;background:var(--green-bg);color:var(--green);padding:8px 12px;border-radius:8px;font-size:12px;margin-bottom:20px;}
#app{display:none;width:100%;}
.sidebar{width:var(--sidebar);min-height:100vh;background:var(--navy);position:fixed;left:0;top:0;display:flex;flex-direction:column;z-index:200;overflow-y:auto;}
.sidebar-logo{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px;}
.sidebar-logo .icon{width:38px;height:38px;background:var(--gold);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.sidebar-logo h2{font-family:'Playfair Display',serif;color:white;font-size:17px;}
.sidebar-logo span{color:rgba(255,255,255,.35);font-size:10px;display:block;letter-spacing:1px;}
.nav-group{padding:12px 0;}
.nav-group-title{color:rgba(255,255,255,.25);font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:6px 20px;margin-bottom:2px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;color:rgba(255,255,255,.55);cursor:pointer;transition:all .15s;font-size:13.5px;font-weight:500;position:relative;}
.nav-item:hover{color:white;background:rgba(255,255,255,.06);}
.nav-item.active{color:var(--gold);background:rgba(232,184,75,.12);}
.nav-item.active::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:3px;background:var(--gold);border-radius:0 3px 3px 0;}
.nav-item .ni{font-size:16px;width:20px;text-align:center;}
.sidebar-user{margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px;}
.ava{width:34px;height:34px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:var(--navy);flex-shrink:0;}
.sidebar-user .info .name{color:white;font-size:13px;font-weight:600;}
.sidebar-user .info .role{color:rgba(255,255,255,.35);font-size:11px;}
.logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:17px;transition:color .2s;}
.logout-btn:hover{color:var(--red);}
.main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;}
.topbar{background:white;padding:14px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.topbar-left h3{font-family:'Playfair Display',serif;font-size:19px;color:var(--navy);}
.topbar-left p{color:var(--muted);font-size:12px;margin-top:1px;}
.topbar-right{display:flex;align-items:center;gap:12px;}
.search-box{display:flex;align-items:center;gap:8px;background:var(--cream);border:1.5px solid var(--border);border-radius:9px;padding:8px 14px;font-size:13px;color:var(--muted);min-width:200px;}
.icon-btn{width:36px;height:36px;border-radius:9px;background:var(--cream);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;position:relative;}
.dot{width:8px;height:8px;background:var(--red);border-radius:50%;position:absolute;top:4px;right:4px;border:2px solid white;}
.page{display:none;padding:24px 28px;animation:fadeIn .3s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.section-head h2{font-family:'Playfair Display',serif;font-size:18px;color:var(--navy);}
.btn{padding:9px 18px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;}
.btn-primary{background:var(--navy);color:white;}
.btn-primary:hover{background:var(--navy3);}
.btn-gold{background:var(--gold);color:var(--navy);}
.btn-outline{background:white;color:var(--navy);border:2px solid var(--border);}
.btn-outline:hover{border-color:var(--navy);}
.btn-sm{padding:6px 12px;font-size:12px;}
.btn-danger{background:var(--red-bg);color:var(--red);border:none;}
.card{background:white;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
.card-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-head h3{font-family:'Playfair Display',serif;font-size:15px;color:var(--navy);}
.card-body{padding:20px;}
.stats-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.stats-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;}
.stat-card{background:white;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:transform .2s;}
.stat-card:hover{transform:translateY(-2px);}
.stat-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;}
.tag{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;}
.tag-green{background:var(--green-bg);color:var(--green);}
.tag-red{background:var(--red-bg);color:var(--red);}
.tag-blue{background:var(--blue-bg);color:var(--blue);}
.tag-orange{background:var(--orange-bg);color:var(--orange);}
.stat-num{font-family:'Playfair Display',serif;font-size:28px;color:var(--navy);line-height:1;}
.stat-label{color:var(--muted);font-size:13px;margin-top:4px;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);padding:10px 14px;border-bottom:2px solid var(--border);font-weight:600;white-space:nowrap;}
td{padding:12px 14px;font-size:13.5px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#f9fafb;}
.td-name{display:flex;align-items:center;gap:10px;}
.mini-ava{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0;}
.status-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;display:inline-block;text-transform:capitalize;}
.s-present,.s-paid,.s-pass,.s-active{background:var(--green-bg);color:var(--green);}
.s-absent,.s-overdue,.s-fail{background:var(--red-bg);color:var(--red);}
.s-late,.s-pending,.s-on_leave{background:var(--orange-bg);color:var(--orange);}
.s-available{background:var(--blue-bg);color:var(--blue);}
.s-issued{background:var(--purple-bg);color:var(--purple);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;}
.g-auto{display:grid;grid-template-columns:1.6fr 1fr;gap:20px;}
.progress{background:#e2e8f0;border-radius:10px;height:7px;margin-top:6px;}
.progress-bar{height:7px;border-radius:10px;}
.ai-box{background:linear-gradient(135deg,var(--navy),var(--navy3));border-radius:var(--radius);padding:20px;color:white;}
.ai-box h4{font-family:'Playfair Display',serif;font-size:15px;color:var(--gold);margin-bottom:6px;}
.ai-box p{font-size:13px;opacity:.7;margin-bottom:14px;}
.ai-suggestion{background:rgba(255,255,255,.08);border-radius:9px;padding:10px 14px;font-size:13px;margin-bottom:8px;border-left:3px solid var(--gold);}
.security-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--green-bg);border-radius:9px;margin-bottom:10px;font-size:13px;color:var(--green);font-weight:500;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-actions{display:flex;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:500;display:none;}
.modal-overlay.open{display:flex;}
.modal{background:white;border-radius:16px;padding:28px;width:560px;max-width:90vw;max-height:85vh;overflow-y:auto;animation:popIn .25s ease;}
.modal h3{font-family:'Playfair Display',serif;font-size:18px;color:var(--navy);margin-bottom:20px;}
.modal-close{float:right;background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:100px;}
.bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.bar{width:100%;border-radius:5px 5px 0 0;min-width:20px;}
.bar-label{font-size:10px;color:var(--muted);}
.bar-val{font-size:10px;font-weight:600;color:var(--navy);}
.mt16{margin-top:16px;}
.fw600{font-weight:600;}
.text-muted{color:var(--muted);font-size:13px;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-thumb{background:#c5d0de;border-radius:10px;}

/* ===== MOBILE RESPONSIVE ===== */
.hamburger{display:none;position:fixed;top:16px;left:16px;z-index:300;background:var(--navy);border:none;border-radius:8px;padding:8px 10px;cursor:pointer;font-size:18px;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:150;}

@media(max-width:768px){
  .hamburger{display:block;}
  .sidebar{transform:translateX(-100%);transition:transform .3s ease;}
  .sidebar.open{transform:translateX(0);}
  .sidebar-overlay.open{display:block;}
  .main{margin-left:0;}
  .topbar{padding:14px 16px 14px 60px;}
  .topbar-left h3{font-size:16px;}
  .page{padding:16px;}
  .stats-4{grid-template-columns:repeat(2,1fr);gap:12px;}
  .stats-3{grid-template-columns:repeat(2,1fr);gap:12px;}
  .g2,.g3,.g-auto{grid-template-columns:1fr;}
  .form-grid{grid-template-columns:1fr;}
  .search-box{display:none;}
  .stat-num{font-size:22px;}
  .topbar-right{gap:8px;}
  .login-box{width:95vw;padding:32px 24px;}
  table{font-size:12px;}
  th,td{padding:8px 10px;}
  .modal{width:95vw;padding:20px;}
}
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p>EduCore Pro load ho raha hai...</p></div>

<div id="loginPage">
  <div class="login-box">
    <div class="login-logo">
      <div style="font-size:40px">ğŸ“</div>
      <h1>EduCore Pro</h1>
      <p>Podar School Management System</p>
      <span class="badge">ğŸ”’ Supabase Secured</span>
    </div>
    <div class="sec-note">ğŸ›¡ï¸ SSL Encrypted â€” Tumhara data safe hai</div>
    <div class="error-msg" id="errorMsg">âŒ Email ya password galat hai!</div>
    <div class="success-msg" id="successMsg">âœ… Login ho rahe hain...</div>
    <div class="fg"><label>Email</label><input type="email" id="loginEmail" placeholder="admin@podarschool.com"></div>
    <div class="fg"><label>Password</label><input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <button class="login-btn" id="loginBtn" onclick="doLogin()">ğŸ” Secure Login</button>
    <p style="text-align:center;color:var(--muted);font-size:12px;margin-top:14px;">Powered by Supabase | <span style="color:var(--gold);font-weight:600;">End-to-End Encrypted</span></p>
  </div>
</div>

<div id="app">
<button class="hamburger" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<aside class="sidebar" id="mainSidebar">
  <div class="sidebar-logo">
    <div class="icon">ğŸ“</div>
    <div><h2>EduCore</h2><span>Podar School ERP</span></div>
  </div>
  <nav>
    <div class="nav-group">
      <div class="nav-group-title">Main</div>
      <div class="nav-item active" onclick="showPage('dashboard',this)"><span class="ni">ğŸ“Š</span> Dashboard</div>
      <div class="nav-item" onclick="showPage('students',this)"><span class="ni">ğŸ‘¨â€ğŸ“</span> Students</div>
      <div class="nav-item" onclick="showPage('teachers',this)"><span class="ni">ğŸ‘©â€ğŸ«</span> Teachers</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-title">Academics</div>
      <div class="nav-item" onclick="showPage('attendance',this)"><span class="ni">âœ…</span> Attendance</div>
      <div class="nav-item" onclick="showPage('exams',this)"><span class="ni">ğŸ“</span> Exams & Marks</div>
      <div class="nav-item" onclick="showPage('library',this)"><span class="ni">ğŸ“š</span> Library</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-title">Finance</div>
      <div class="nav-item" onclick="showPage('fees',this)"><span class="ni">ğŸ’°</span> Fee Management</div>
      <div class="nav-item" onclick="showPage('payroll',this)"><span class="ni">ğŸ’¼</span> Staff Payroll</div>
      <div class="nav-item" onclick="showPage('reports',this)"><span class="ni">ğŸ“ˆ</span> Reports</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-title">System</div>
      <div class="nav-item" onclick="showPage('security',this)"><span class="ni">ğŸ”’</span> Security</div>
      <div class="nav-item" onclick="showPage('settings',this)"><span class="ni">âš™ï¸</span> Settings</div>
    </div>
  </nav>
  <div class="sidebar-user">
    <div class="ava">AD</div>
    <div class="info"><div class="name" id="userEmailDisplay">Admin</div><div class="role">Super Admin</div></div>
    <button class="logout-btn" onclick="doLogout()">â»</button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-left"><h3 id="pageTitle">Dashboard</h3><p id="pageSubtitle">Welcome back!</p></div>
    <div class="topbar-right">
      <div class="search-box">ğŸ” Search...</div>
      <div class="icon-btn">ğŸ””<div class="dot"></div></div>
      <div class="icon-btn">ğŸ“§</div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="stats-4">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ‘¨â€ğŸ“</div><span class="tag tag-green" id="d-s-tag">â€”</span></div><div class="stat-num" id="d-s-num">â€”</div><div class="stat-label">Total Students</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">ğŸ‘©â€ğŸ«</div><span class="tag tag-blue" id="d-t-tag">â€”</span></div><div class="stat-num" id="d-t-num">â€”</div><div class="stat-label">Total Teachers</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">ğŸ’°</div><span class="tag tag-green">Paid</span></div><div class="stat-num" id="d-f-paid">â€”</div><div class="stat-label">Fee Paid</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">âš ï¸</div><span class="tag tag-red">Due</span></div><div class="stat-num" id="d-f-due">â€”</div><div class="stat-label">Fee Pending</div></div>
    </div>
    <div class="g-auto">
      <div style="display:flex;flex-direction:column;gap:20px;">
        <div class="card">
          <div class="card-head"><h3>Weekly Attendance</h3><span class="tag tag-green">94% Avg</span></div>
          <div class="card-body">
            <div class="bar-chart">
              <div class="bar-wrap"><div class="bar-val">96%</div><div class="bar" style="height:96px;background:var(--navy)"></div><div class="bar-label">Mon</div></div>
              <div class="bar-wrap"><div class="bar-val">94%</div><div class="bar" style="height:94px;background:var(--navy)"></div><div class="bar-label">Tue</div></div>
              <div class="bar-wrap"><div class="bar-val">91%</div><div class="bar" style="height:91px;background:var(--navy)"></div><div class="bar-label">Wed</div></div>
              <div class="bar-wrap"><div class="bar-val">97%</div><div class="bar" style="height:97px;background:var(--gold)"></div><div class="bar-label">Thu</div></div>
              <div class="bar-wrap"><div class="bar-val">93%</div><div class="bar" style="height:93px;background:var(--navy)"></div><div class="bar-label">Fri</div></div>
              <div class="bar-wrap"><div class="bar-val">89%</div><div class="bar" style="height:89px;background:var(--navy)"></div><div class="bar-label">Sat</div></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>Recent Students</h3><button class="btn btn-sm btn-outline" onclick="showPage('students',null)">View All</button></div>
          <div class="table-wrap"><table><thead><tr><th>Student</th><th>Class</th><th>Fee</th></tr></thead><tbody id="d-students">
            <tr><td colspan="3" style="text-align:center;padding:20px;color:var(--muted)">Loading...</td></tr>
          </tbody></table></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:20px;">
        <div class="ai-box">
          <h4>ğŸ¤– AI Insights</h4><p>Live database se</p>
          <div class="ai-suggestion" id="ai1">ğŸ“Š Data load ho raha hai...</div>
          <div class="ai-suggestion" id="ai2">ğŸ’¡ Analyzing...</div>
          <div class="ai-suggestion" id="ai3">ğŸ”„ Please wait...</div>
        </div>
        <div class="card">
          <div class="card-head"><h3>Summary</h3></div>
          <div class="card-body">
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;"><span>Students</span><span class="fw600" id="p-s">â€”</span></div><div class="progress"><div class="progress-bar" id="p-s-bar" style="width:0%;background:var(--green)"></div></div></div>
              <div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;"><span>Fee Paid</span><span class="fw600" id="p-f">â€”</span></div><div class="progress"><div class="progress-bar" id="p-f-bar" style="width:0%;background:var(--blue)"></div></div></div>
              <div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;"><span>Teachers Active</span><span class="fw600" id="p-t">â€”</span></div><div class="progress"><div class="progress-bar" id="p-t-bar" style="width:0%;background:var(--gold)"></div></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div class="page" id="page-students">
    <div class="section-head"><h2>Student Management</h2><button class="btn btn-primary" onclick="openModal('addStudent')">+ Add Student</button></div>
    <div class="stats-4" style="margin-bottom:20px;">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ‘¨â€ğŸ“</div></div><div class="stat-num" id="s-total">â€”</div><div class="stat-label">Total</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">âœ…</div></div><div class="stat-num" id="s-paid">â€”</div><div class="stat-label">Fee Paid</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">â°</div></div><div class="stat-num" id="s-pending">â€”</div><div class="stat-label">Pending</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">ğŸš¨</div></div><div class="stat-num" id="s-overdue">â€”</div><div class="stat-label">Overdue</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>All Students</h3><button class="btn btn-sm btn-outline" onclick="loadStudents()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Student</th><th>Class</th><th>Section</th><th>Parent</th><th>Phone</th><th>Fee Status</th><th>Action</th></tr></thead><tbody id="studentsTable"><tr><td colspan="8" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- TEACHERS -->
  <div class="page" id="page-teachers">
    <div class="section-head"><h2>Teachers & Staff</h2><button class="btn btn-primary" onclick="openModal('addTeacher')">+ Add Teacher</button></div>
    <div class="stats-3">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">ğŸ‘©â€ğŸ«</div></div><div class="stat-num" id="t-total">â€”</div><div class="stat-label">Total</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">âœ…</div></div><div class="stat-num" id="t-active">â€”</div><div class="stat-label">Active</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">ğŸ’°</div></div><div class="stat-num" id="t-payroll">â€”</div><div class="stat-label">Monthly Payroll</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>All Teachers</h3><button class="btn btn-sm btn-outline" onclick="loadTeachers()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Subject</th><th>Class</th><th>Phone</th><th>Net Salary</th><th>Status</th></tr></thead><tbody id="teachersTable"><tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div class="page" id="page-attendance">
    <div class="section-head"><h2>Attendance</h2></div>
    <div class="stats-4">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">âœ…</div></div><div class="stat-num" id="att-present">â€”</div><div class="stat-label">Present</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">âŒ</div></div><div class="stat-num" id="att-absent">â€”</div><div class="stat-label">Absent</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">â°</div></div><div class="stat-num" id="att-late">â€”</div><div class="stat-label">Late</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ“Š</div></div><div class="stat-num" id="att-total">â€”</div><div class="stat-label">Total Records</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>Attendance Records</h3><button class="btn btn-sm btn-outline" onclick="loadAttendance()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>Student</th><th>Class</th><th>Date</th><th>Status</th><th>Time In</th></tr></thead><tbody id="attendanceTable"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- EXAMS -->
  <div class="page" id="page-exams">
    <div class="section-head"><h2>Exams & Results</h2></div>
    <div class="stats-4">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">âœ…</div></div><div class="stat-num" id="ex-pass">â€”</div><div class="stat-label">Passed</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">âŒ</div></div><div class="stat-num" id="ex-fail">â€”</div><div class="stat-label">Failed</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ“Š</div></div><div class="stat-num" id="ex-avg">â€”</div><div class="stat-label">Avg %</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">â­</div></div><div class="stat-num" id="ex-total">â€”</div><div class="stat-label">Total</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>Results</h3><button class="btn btn-sm btn-outline" onclick="loadExams()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>Student</th><th>Class</th><th>Exam</th><th>Total</th><th>%</th><th>Grade</th><th>Result</th></tr></thead><tbody id="examsTable"><tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- FEES -->
  <div class="page" id="page-fees">
    <div class="section-head"><h2>Fee Management</h2></div>
    <div class="stats-4">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">ğŸ’°</div></div><div class="stat-num" id="f-paid">â€”</div><div class="stat-label">Paid</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fef3c7">â°</div></div><div class="stat-num" id="f-pending">â€”</div><div class="stat-label">Pending</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">ğŸš¨</div></div><div class="stat-num" id="f-overdue">â€”</div><div class="stat-label">Overdue</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ’µ</div></div><div class="stat-num" id="f-amount">â€”</div><div class="stat-label">Total Amount</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>Fee Records</h3><button class="btn btn-sm btn-outline" onclick="loadFees()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>Student</th><th>Class</th><th>Type</th><th>Amount</th><th>Due Date</th><th>Status</th><th>Receipt</th></tr></thead><tbody id="feesTable"><tr><td colspan="6" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- LIBRARY -->
  <div class="page" id="page-library">
    <div class="section-head"><h2>Library</h2></div>
    <div class="stats-4">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">ğŸ“š</div></div><div class="stat-num" id="lib-total">â€”</div><div class="stat-label">Total Books</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">âœ…</div></div><div class="stat-num" id="lib-avail">â€”</div><div class="stat-label">Available</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#ede9fe">ğŸ“¤</div></div><div class="stat-num" id="lib-issued">â€”</div><div class="stat-label">Issued</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">â°</div></div><div class="stat-num" id="lib-overdue">â€”</div><div class="stat-label">Overdue</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>All Books</h3><button class="btn btn-sm btn-outline" onclick="loadLibrary()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>Title</th><th>Author</th><th>Category</th><th>Total</th><th>Available</th><th>Status</th></tr></thead><tbody id="libraryTable"><tr><td colspan="6" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- PAYROLL -->
  <div class="page" id="page-payroll">
    <div class="section-head"><h2>Staff Payroll</h2></div>
    <div class="stats-3">
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dcfce7">ğŸ’°</div></div><div class="stat-num" id="pay-total">â€”</div><div class="stat-label">Total Payroll</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#dbeafe">âœ…</div></div><div class="stat-num" id="pay-paid">â€”</div><div class="stat-label">Paid</div></div>
      <div class="stat-card"><div class="stat-top"><div class="stat-icon" style="background:#fee2e2">â³</div></div><div class="stat-num" id="pay-pending">â€”</div><div class="stat-label">Pending</div></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>Payroll Records</h3><button class="btn btn-sm btn-outline" onclick="loadPayroll()">ğŸ”„ Refresh</button></div>
      <div class="table-wrap"><table><thead><tr><th>Staff</th><th>Role</th><th>Basic</th><th>Gross</th><th>Deductions</th><th>Net</th><th>Status</th></tr></thead><tbody id="payrollTable"><tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Loading...</td></tr></tbody></table></div>
    </div>
  </div>

  <!-- REPORTS -->
  <div class="page" id="page-reports">
    <div class="section-head"><h2>Reports</h2></div>
    <div class="g3 mt16">
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ“Š Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ“Š</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Attendance</div></div></div>
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ’° Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ’°</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Fee Report</div></div></div>
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ“ Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ“</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Exam Results</div></div></div>
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ‘¨â€ğŸ“ Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ‘¨â€ğŸ“</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Report Cards</div></div></div>
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ’¼ Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ’¼</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Payroll</div></div></div>
      <div class="card" style="cursor:pointer" onclick="showToast('ğŸ“š Report ready!')"><div class="card-body" style="text-align:center;padding:28px"><div style="font-size:36px">ğŸ“š</div><div class="fw600" style="margin-top:10px;color:var(--navy)">Library</div></div></div>
    </div>
  </div>

  <!-- SECURITY -->
  <div class="page" id="page-security">
    <div class="section-head"><h2>Security</h2></div>
    <div style="background:var(--green-bg);color:var(--green);padding:12px 16px;border-radius:9px;font-size:13px;margin-bottom:20px;">ğŸ”’ System Secure â€” Supabase Auth Active â€” SSL Enabled</div>
    <div class="card"><div class="card-head"><h3>ğŸ›¡ï¸ Security Features</h3></div><div class="card-body">
      <div class="security-row">âœ… Supabase Authentication â€” Active</div>
      <div class="security-row">âœ… SSL/TLS Encryption â€” Active</div>
      <div class="security-row">âœ… JWT Token Security â€” Active</div>
      <div class="security-row">âœ… Row Level Security (RLS) â€” Active</div>
      <div class="security-row">âœ… Auto Session Logout â€” 1 hour</div>
      <div class="security-row">âœ… Password Hashing â€” bcrypt</div>
      <div class="security-row">âœ… Daily Backups â€” Supabase Cloud</div>
    </div></div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div class="section-head"><h2>Settings</h2><button class="btn btn-primary">ğŸ’¾ Save</button></div>
    <div class="card"><div class="card-head"><h3>ğŸ« School Info</h3></div><div class="card-body">
      <div class="form-grid" style="gap:14px;">
        <div class="fg"><label>School Name</label><input type="text" value="Podar School"></div>
        <div class="fg"><label>Principal</label><input type="text" value="Dr. Ramesh Gupta"></div>
        <div class="fg"><label>Phone</label><input type="text" value="+91 98765-43210"></div>
        <div class="fg"><label>Board</label><select><option>CBSE</option><option>ICSE</option><option>State Board</option></select></div>
        <div class="fg" style="grid-column:span 2"><label>Address</label><input type="text" value="Nashik, Maharashtra"></div>
      </div>
    </div></div>
  </div>

</div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-addStudent">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addStudent')">âœ•</button>
    <h3>â• Add Student</h3>
    <div class="form-grid">
      <div class="fg"><label>Name</label><input type="text" id="ns-name" placeholder="Aarav Kumar"></div>
      <div class="fg"><label>Class</label><input type="text" id="ns-class" placeholder="10"></div>
      <div class="fg"><label>Section</label><input type="text" id="ns-section" placeholder="A"></div>
      <div class="fg"><label>Roll No</label><input type="text" id="ns-roll" placeholder="01"></div>
      <div class="fg"><label>Parent Name</label><input type="text" id="ns-parent" placeholder="Rajesh Kumar"></div>
      <div class="fg"><label>Phone</label><input type="tel" id="ns-phone" placeholder="98765-43210"></div>
      <div class="fg"><label>Fee Status</label><select id="ns-fee"><option value="pending">Pending</option><option value="paid">Paid</option><option value="overdue">Overdue</option></select></div>
      <div class="fg"><label>Address</label><input type="text" id="ns-address" placeholder="Nashik"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="addStudent()">âœ… Save</button>
      <button class="btn btn-outline" onclick="closeModal('addStudent')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-addTeacher">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addTeacher')">âœ•</button>
    <h3>â• Add Teacher</h3>
    <div class="form-grid">
      <div class="fg"><label>Name</label><input type="text" id="nt-name" placeholder="Sunita Rao"></div>
      <div class="fg"><label>Subject</label><input type="text" id="nt-subject" placeholder="Mathematics"></div>
      <div class="fg"><label>Phone</label><input type="tel" id="nt-phone" placeholder="99887-76655"></div>
      <div class="fg"><label>Basic Salary</label><input type="number" id="nt-salary" placeholder="42000"></div>
      <div class="fg"><label>Class Incharge</label><input type="text" id="nt-class" placeholder="10"></div>
      <div class="fg"><label>Status</label><select id="nt-status"><option value="active">Active</option><option value="on_leave">On Leave</option></select></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="addTeacher()">âœ… Save</button>
      <button class="btn btn-outline" onclick="closeModal('addTeacher')">Cancel</button>
    </div>
  </div>
</div>

<script>
const SURL='https://zaukdakfcsmckbzvknaf.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphdWtkYWtmY3NtY2tienZrbmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjI0NDIsImV4cCI6MjA4NzIzODQ0Mn0.zgZhm5sSVTl9mz-IOc-sYQvTaPveuA90_VPpqRGKuxM';
const sb=window.supabase.createClient(SURL,SKEY);
const CLR=['#2563eb','#7c3aed','#16a34a','#d97706','#dc2626','#0891b2','#be185d'];
const gc=i=>CLR[i%CLR.length];
const ini=n=>n?n.split(' ').map(x=>x[0]).join('').toUpperCase().slice(0,2):'??';
const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
const qs=(sel,html)=>{const e=document.querySelector(sel);if(e)e.innerHTML=html;};

let currentRole='admin';

async function loadUserRole(email){
  const{data}=await sb.from('user_roles').select('*').eq('email',email).single();
  if(data) currentRole=data.role;
  else currentRole='admin';
  const roleNames={admin:'ğŸ‘¨â€ğŸ’¼ Super Admin',accountant:'ğŸ’° Accountant',teacher:'ğŸ‘©â€ğŸ« Teacher'};
  const roleEl=document.querySelector('.sidebar-user .info .role');
  if(roleEl) roleEl.textContent=roleNames[currentRole]||currentRole;
}

function applyRoleAccess(){
  if(currentRole==='accountant'){
    // Accountant sirf fees dekh sakta hai
    ['students','teachers','attendance','exams','library','payroll','reports','security','settings'].forEach(p=>{
      const el=document.querySelector(`[onclick="showPage('${p}',this)"]`);
      if(el) el.style.display='none';
    });
    showPage('fees',document.querySelector(`[onclick="showPage('fees',this)"]`));
    showToast('ğŸ’° Accountant Login â€” Sirf Fee Management visible hai');
  }
}

async function init(){
  const{data:{session}}=await sb.auth.getSession();
  document.getElementById('loading').style.display='none';
  if(session){
    set('userEmailDisplay',session.user.email.split('@')[0]);
    await loadUserRole(session.user.email);
    document.getElementById('app').style.display='flex';
    applyRoleAccess();
    if(currentRole==='admin') loadDashboard();
  } else {
    document.getElementById('loginPage').style.display='flex';
  }
}
init();

async function doLogin(){
  const email=document.getElementById('loginEmail').value;
  const pass=document.getElementById('loginPassword').value;
  const btn=document.getElementById('loginBtn');
  const err=document.getElementById('errorMsg');
  const suc=document.getElementById('successMsg');
  if(!email||!pass){err.style.display='block';err.innerHTML='âŒ Email aur password zaroori hai!';return;}
  btn.disabled=true;btn.innerHTML='â³ Login...';err.style.display='none';
  const{data,error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){err.style.display='block';err.innerHTML='âŒ Email ya password galat hai!';btn.disabled=false;btn.innerHTML='ğŸ” Secure Login';}
  else{
    suc.style.display='block';suc.innerHTML='âœ… Login successful!';
    set('userEmailDisplay',email.split('@')[0]);
    setTimeout(()=>{document.getElementById('loginPage').style.display='none';document.getElementById('app').style.display='flex';loadDashboard();},800);
  }
}
document.addEventListener('keypress',e=>{if(e.key==='Enter')doLogin();});

async function doLogout(){
  if(confirm('Logout karna chahte hain?')){
    await sb.auth.signOut();
    document.getElementById('app').style.display='none';
    document.getElementById('loginPage').style.display='flex';
  }
}

const pageInfo={
  dashboard:{title:'Dashboard',sub:'Welcome back! Aaj school mein kya ho raha hai.'},
  students:{title:'Students',sub:'Sab students ke records.'},
  teachers:{title:'Teachers',sub:'Teaching staff.'},
  attendance:{title:'Attendance',sub:'Daily attendance.'},
  exams:{title:'Exams & Results',sub:'Results manage karo.'},
  library:{title:'Library',sub:'Books manage karo.'},
  fees:{title:'Fee Management',sub:'Fee track karo.'},
  payroll:{title:'Payroll',sub:'Salary manage karo.'},
  reports:{title:'Reports',sub:'Reports generate karo.'},
  security:{title:'Security',sub:'Security settings.'},
  settings:{title:'Settings',sub:'School info update karo.'},
};

function showPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+id);
  if(pg)pg.classList.add('active');
  if(el)el.classList.add('active');
  if(pageInfo[id]){set('pageTitle',pageInfo[id].title);set('pageSubtitle',pageInfo[id].sub);}
  if(id==='students')loadStudents();
  if(id==='teachers')loadTeachers();
  if(id==='attendance')loadAttendance();
  if(id==='exams')loadExams();
  if(id==='fees')loadFees();
  if(id==='library')loadLibrary();
  if(id==='payroll')loadPayroll();
}

async function loadDashboard(){
  const[s,t,f,a]=await Promise.all([
    sb.from('students').select('*'),
    sb.from('teachers table').select('*'),
    sb.from('fees').select('*'),
    sb.from('Attendance').select('*')
  ]);
  const sd=s.data||[],td=t.data||[],fd=f.data||[],ad=a.data||[];
  set('d-s-num',sd.length);set('d-s-tag',sd.length+' Total');
  set('d-t-num',td.length);set('d-t-tag',td.length+' Active');
  const paid=fd.filter(x=>x.status==='paid').length;
  const due=fd.filter(x=>x.status!=='paid').length;
  set('d-f-paid',paid+' Students');set('d-f-due',due+' Students');
  set('p-s',sd.length);document.getElementById('p-s-bar').style.width=Math.min(sd.length/20*100,100)+'%';
  const fp=fd.length?Math.round(paid/fd.length*100):0;
  set('p-f',fp+'%');document.getElementById('p-f-bar').style.width=fp+'%';
  const at=td.filter(x=>x.status==='active').length;
  set('p-t',at+'/'+td.length);document.getElementById('p-t-bar').style.width=(td.length?Math.round(at/td.length*100):0)+'%';
  const tbody=document.getElementById('d-students');
  tbody.innerHTML=sd.slice(0,4).map((s,i)=>`<tr><td><div class="td-name"><div class="mini-ava" style="background:${gc(i)}">${ini(s.name)}</div>${s.name||'â€”'}</div></td><td>${s.class||'â€”'}</td><td><span class="status-badge s-${s.fee_status||'pending'}">${s.fee_status||'pending'}</span></td></tr>`).join('')||'<tr><td colspan="3" style="text-align:center;color:var(--muted)">Koi data nahi</td></tr>';
  const ov=fd.filter(x=>x.status==='overdue').length;
  const ab=ad.filter(x=>x.status==='absent').length;
  set('ai1','ğŸ‘¨â€ğŸ“ Total '+sd.length+' students registered hain');
  set('ai2','ğŸ’¸ '+ov+' students ke fees overdue hain!');
  set('ai3','ğŸ“Š '+ab+' absent records aaj hain');
}

async function loadStudents(){
  const{data}=await sb.from('students').select('*');
  const d=data||[];
  set('s-total',d.length);
  set('s-paid',d.filter(x=>x.fee_status==='paid').length);
  set('s-pending',d.filter(x=>x.fee_status==='pending').length);
  set('s-overdue',d.filter(x=>x.fee_status==='overdue').length);
  document.getElementById('studentsTable').innerHTML=d.map((s,i)=>`
    <tr><td>${i+1}</td>
    <td><div class="td-name"><div class="mini-ava" style="background:${gc(i)}">${ini(s.name)}</div>${s.name||'â€”'}</div></td>
    <td>${s.class||'â€”'}</td><td>${s.section||'â€”'}</td>
    <td>${s.parent_name||'â€”'}</td><td>${s.phone||'â€”'}</td>
    <td><span class="status-badge s-${s.fee_status||'pending'}">${s.fee_status||'pending'}</span></td>
    <td><button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">ğŸ—‘ï¸</button></td></tr>
  `).join('')||'<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--muted)">Koi student nahi</td></tr>';
}

async function addStudent(){
  const name=document.getElementById('ns-name').value;
  if(!name){showToast('âŒ Name zaroori hai!');return;}
  const{error}=await sb.from('students').insert([{
    name,class:document.getElementById('ns-class').value,
    section:document.getElementById('ns-section').value,
    roll_no:document.getElementById('ns-roll').value,
    parent_name:document.getElementById('ns-parent').value,
    phone:document.getElementById('ns-phone').value,
    fee_status:document.getElementById('ns-fee').value,
    address:document.getElementById('ns-address').value
  }]);
  if(error){showToast('âŒ Error: '+error.message);return;}
  showToast('âœ… Student add ho gaya!');closeModal('addStudent');loadStudents();
}

async function deleteStudent(id){
  if(!confirm('Delete karna chahte hain?'))return;
  await sb.from('students').delete().eq('id',id);
  showToast('ğŸ—‘ï¸ Deleted!');loadStudents();
}

async function loadTeachers(){
  const{data}=await sb.from('teachers table').select('*');
  const d=data||[];
  set('t-total',d.length);
  set('t-active',d.filter(x=>x.status==='active').length);
  const tp=d.reduce((s,x)=>s+(parseInt(x.net_salary)||0),0);
  set('t-payroll','â‚¹'+Math.round(tp/1000)+'K');
  document.getElementById('teachersTable').innerHTML=d.map((t,i)=>`
    <tr><td>${i+1}</td>
    <td><div class="td-name"><div class="mini-ava" style="background:${gc(i)}">${ini(t.name)}</div>${t.name||'â€”'}</div></td>
    <td>${t.subject||'â€”'}</td><td>${t.class_incharge||'â€”'}</td>
    <td>${t.phone||'â€”'}</td><td>â‚¹${t.net_salary||'â€”'}</td>
    <td><span class="status-badge s-${t.status||'active'}">${t.status||'active'}</span></td></tr>
  `).join('')||'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Koi teacher nahi</td></tr>';
}

async function addTeacher(){
  const name=document.getElementById('nt-name').value;
  if(!name){showToast('âŒ Name zaroori hai!');return;}
  const basic=parseInt(document.getElementById('nt-salary').value)||0;
  const{error}=await sb.from('teachers table').insert([{
    name,subject:document.getElementById('nt-subject').value,
    phone:document.getElementById('nt-phone').value,
    basic_salary:basic,net_salary:Math.round(basic*1.15),
    class_incharge:document.getElementById('nt-class').value,
    status:document.getElementById('nt-status').value
  }]);
  if(error){showToast('âŒ Error: '+error.message);return;}
  showToast('âœ… Teacher add ho gaya!');closeModal('addTeacher');loadTeachers();
}

async function loadAttendance(){
  const{data}=await sb.from('Attendance').select('*');
  const d=data||[];
  set('att-present',d.filter(x=>x.status==='present').length);
  set('att-absent',d.filter(x=>x.status==='absent').length);
  set('att-late',d.filter(x=>x.status==='late').length);
  set('att-total',d.length);
  document.getElementById('attendanceTable').innerHTML=d.map(a=>`
    <tr><td>${a.student_name||'â€”'}</td><td>${a.class||'â€”'}</td>
    <td>${a.date||'â€”'}</td>
    <td><span class="status-badge s-${a.status||'present'}">${a.status||'â€”'}</span></td>
    <td>${a.time_in||'â€”'}</td></tr>
  `).join('')||'<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--muted)">Koi record nahi</td></tr>';
}

async function loadExams(){
  const{data}=await sb.from('exams').select('*');
  const d=data||[];
  set('ex-pass',d.filter(x=>x.result==='pass').length);
  set('ex-fail',d.filter(x=>x.result==='fail').length);
  set('ex-total',d.length);
  const avg=d.length?Math.round(d.reduce((s,x)=>s+(parseFloat(x.percentage)||0),0)/d.length):0;
  set('ex-avg',avg+'%');
  document.getElementById('examsTable').innerHTML=d.map(e=>`
    <tr><td>${e.student_name||'â€”'}</td><td>${e.class||'â€”'}</td>
    <td>${e.exam_name||'â€”'}</td><td>${e.total||'â€”'}</td>
    <td>${e.percentage||'â€”'}%</td><td>${e.grade||'â€”'}</td>
    <td><span class="status-badge s-${e.result||'pass'}">${e.result||'â€”'}</span></td></tr>
  `).join('')||'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Koi result nahi</td></tr>';
}

async function loadFees(){
  const{data}=await sb.from('fees').select('*');
  const d=data||[];
  set('f-paid',d.filter(x=>x.status==='paid').length);
  set('f-pending',d.filter(x=>x.status==='pending').length);
  set('f-overdue',d.filter(x=>x.status==='overdue').length);
  set('f-amount','â‚¹'+d.reduce((s,x)=>s+(parseInt(x.amount)||0),0).toLocaleString());
  document.getElementById('feesTable').innerHTML=d.map(f=>`
    <tr><td>${f.student_name||'â€”'}</td><td>${f.class||'â€”'}</td>
    <td>${f.fee_type||'â€”'}</td><td>â‚¹${f.amount||'â€”'}</td>
    <td>${f.due_date||'â€”'}</td>
    <td><span class="status-badge s-${f.status||'pending'}">${f.status||'â€”'}</span></td><td><button class="btn btn-sm btn-gold" onclick="openReceipt('${f.student_name}','${f.class}','${f.amount}','${f.status}')">ğŸ–¨ï¸ Receipt</button></td></tr>
  `).join('')||'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--muted)">Koi fee nahi</td></tr>';
}

async function loadLibrary(){
  const{data}=await sb.from('library').select('*');
  const d=data||[];
  set('lib-total',d.length);
  set('lib-avail',d.filter(x=>x.status==='available').length);
  set('lib-issued',d.filter(x=>x.status==='issued').length);
  set('lib-overdue',d.filter(x=>x.status==='overdue').length);
  document.getElementById('libraryTable').innerHTML=d.map(b=>`
    <tr><td>${b.book_title||'â€”'}</td><td>${b.author||'â€”'}</td>
    <td>${b.category||'â€”'}</td><td>${b.total_copies||'â€”'}</td>
    <td>${b.available_copies||'â€”'}</td>
    <td><span class="status-badge s-${b.status||'available'}">${b.status||'â€”'}</span></td></tr>
  `).join('')||'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--muted)">Koi book nahi</td></tr>';
}

async function loadPayroll(){
  const{data}=await sb.from('Payroll').select('*');
  const d=data||[];
  const total=d.reduce((s,x)=>s+(parseInt(x.net_salary)||0),0);
  set('pay-total','â‚¹'+Math.round(total/1000)+'K');
  set('pay-paid',d.filter(x=>x.status==='paid').length);
  set('pay-pending',d.filter(x=>x.status==='pending').length);
  document.getElementById('payrollTable').innerHTML=d.map((p,i)=>`
    <tr>
    <td><div class="td-name"><div class="mini-ava" style="background:${gc(i)}">${ini(p.staff_name)}</div>${p.staff_name||'â€”'}</div></td>
    <td>${p.role||'â€”'}</td><td>â‚¹${p.basic_salary||'â€”'}</td>
    <td>â‚¹${p.gross_salary||'â€”'}</td>
    <td>â‚¹${(parseInt(p.pf_deduction||0)+parseInt(p.tax_deduction||0))}</td>
    <td>â‚¹${p.net_salary||'â€”'}</td>
    <td><span class="status-badge s-${p.status||'pending'}">${p.status||'â€”'}</span></td></tr>
  `).join('')||'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Koi payroll nahi</td></tr>';
}

function openModal(id){document.getElementById('modal-'+id).classList.add('open');}
function closeModal(id){document.getElementById('modal-'+id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

function toggleSidebar(){
  document.getElementById('mainSidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function openReceipt(name, cls, amount, status){
  const url = 'fee_slip.html?name='+encodeURIComponent(name)+'&class='+encodeURIComponent(cls)+'&amount='+encodeURIComponent(amount)+'&status='+encodeURIComponent(status);
  window.open(url, '_blank');
}

function showToast(msg){   â† yeh wali line pehle se hai
function showToast(msg){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;top:20px;right:20px;z-index:9999;background:var(--green-bg);color:var(--green);padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.1);';
  t.innerHTML=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}
</script>
</body>
</html>
